FROM php:7.4-apache-bullseye

# Actualizar e instalar dependencias necesarias
RUN apt-get update && apt-get install -y \
    git \
    openssl \
    libpng-dev \
    libjpeg62-turbo-dev \
    libfreetype6-dev \
    libzip-dev \
    zip \
    unzip \
    && docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-install gd mysqli pdo pdo_mysql zip

# Generar certificados SSL v치lidos autom치ticamente
RUN mkdir -p /etc/ssl/private /etc/ssl/certs && \
    openssl req -x509 -nodes -days 365 \
    -newkey rsa:2048 \
    -keyout /etc/ssl/private/ssl.key \
    -out /etc/ssl/certs/ssl.crt \
    -subj "/C=ES/ST=Valencia/L=Valencia/O=Proyecto/OU=Dev/CN=localhost"

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Copiar archivo de configuraci칩n unificado
COPY config/apache.conf /etc/apache2/conf-available/proyecto.conf
RUN a2enconf proyecto

# Activar m칩dulos necesarios
RUN a2enmod ssl rewrite headers

EXPOSE 80 443

# Este script clona el repositorio o le hace pull cada vez que se ejecuta
ENTRYPOINT ["/entrypoint.sh"]
